#Azure 服務匯流排

無論應用程式或服務是在雲端或內部部署中執行，通常都需要與其他應用程式或服務互動。Azure 提供「服務匯流排」，讓您有更多實用的作法。本文探討這項技術，並說明其為何物及為何需要採用。

## 服務匯流排基本概念
不同的情況需要不同的通訊方式。有時，讓應用程式透過簡單的佇列來傳送和接收訊息，就是最好的解決方案。在其他情況下，普通的佇列仍嫌不足，具有發佈與訂閱機制的佇列會更好。在某些情況下，就只需要應用程式之間的連線，根本不需要佇列。服務匯流排提供這三種選項，可讓應用程式以幾種不同的方式互動。

服務匯流排是多租用戶的雲端服務，亦即，由多位使用者共用服務。每個使用者 (例如應用程式開發人員) 可建立*命名空間*，然後在該命名空間內定義所需的通訊機制。[圖 1](#Fig1) 顯示運作架構。

<a name="Fig1"></a>![Azure 服務匯流排圖表][svc-bus]
 
**圖 1：服務匯流排提供多租用戶服務，可透過雲端連接應用程式。**

在一個命名空間內，您可以使用四種不同通訊機制的一或多個執行個體，這些機制各以不同的方式連接應用程式。選擇如下：

- *佇列*，允許單向通訊。每個佇列扮演中繼角色 (有時稱為*代理人*)，儲存已傳送但尚未接收的訊息。每個訊息會由單一收件者接收。
- *主題*，提供使用*訂用帳戶*的單向通訊，而單一主題可以有多個訂用帳戶。就像佇列一樣，主題也扮演代理人的角色，但每個訂用帳戶可選擇性地使用篩選條件，以便只接收符合特定準則的訊息。
- *轉送*，提供雙向通訊。與佇列和主題不同，轉送不是代理人，不會儲存途中訊息。只是單純地將訊息傳遞至目的地應用程式。
- *事件中樞*，提供雲端的大規模事件和遙測輸入 (具低延遲且高可靠性)。

當您建立佇列、主題、轉送或事件中樞時，您會指定其名稱。此名稱結合命名空間的名稱，就形成物件的唯一識別碼。應用程式可以提供此名稱給服務匯流排，然後利用該佇列、主題、轉送或事件中樞，即可相互通訊。

Windows 應用程式可以利用 Windows Communication Foundation (WCF) 來使用任何這些物件。對於佇列、主題和事件中樞，Windows 應用程式也可以使用服務匯流排定義的訊息 API。為了讓您更輕鬆地從非 Windows 應用程式使用這些物件，Microsoft 提供了 Java、Node.js 和其他語言的 SDK。您也可以透過 HTTP 使用 REST API，存取佇列、主題和事件中樞。

請務必了解，雖然服務匯流排本身是在雲端執行 (亦即，在 Microsoft 的 Azure 資料中心)，但用到服務匯流排的應用程式可在任何地方執行。舉例來說，您可以使用服務匯流排來連接 Azure 上執行的應用程式，或您自己的資料中心內執行的應用程式。服務匯流排也可讓您將 Azure 或其他雲端平台上執行的應用程式，與內部部署應用程式連接，或與平板電腦和電話連接。甚至可以將家電產品、感應器和其他裝置，連接至中央應用程式或其他應用程式。服務匯流排是雲端中通用的通訊機制，幾乎從任何地方都能存取。用途視應用程式的需求而定。


## 佇列

假設您決定使用服務匯流排佇列來連接兩個應用程式。[圖 2](#Fig2) 顯示此情形。

<a name="Fig2"></a>![服務匯流排佇列的圖表][queues]
 
**圖 2：服務匯流排佇列提供單向非同步的佇列作業。**

程序非常簡單：傳送者將訊息傳送至服務匯流排佇列，稍後由接收者取得該訊息。一個佇列只有一個接收者，如[圖 2](#Fig2) 所示，或者，多個應用程式可以讀取相同的佇列。在後面的情況下，每個訊息只由一個接收者讀取，對於多點傳送服務，您應改用主題。

每個訊息有兩個部分：一組屬性 (各為機碼/值組) 和二進位訊息本文。他們的使用方式會取決於應用程式的目的。例如，假設應用程式會傳送最近一筆交易的相關訊息，則可能包含屬性 *Seller="Ava"* 和 *Amount=10000*。訊息本文可能包含該交易簽訂之合約的掃描影像，如果沒有的話，則維持空白。

接收者以兩種不同的方法從服務匯流排佇列讀取訊息。第一個選項 (稱為 *ReceiveAndDelete*) 會從佇列中移除訊息，並立即刪除訊息。這很簡單，但如果接收者在完成訊息處理之前當掉，則會遺失訊息。因為訊息已從佇列中移除，其他接收者無法再取得該訊息。

第二個選項 *PeekLock* 就是為了解決此問題。就像 ReceiveAndDelete 一樣，PeekLock 讀取也會從佇列中移除訊息，但並不會刪除訊息。相反地，此選項會鎖定訊息，不讓其他接收者看到訊息，然後等待三種事件發生：

- 如果接收者成功處理訊息，則會呼叫 *Complete*，然後佇列會刪除訊息。 
- 如果接收者判斷無法成功處理訊息，則會呼叫 *Abandon*。然後，佇列會解除訊息的鎖定，讓其他接收者可以存取訊息。
- 如果接收者在一段可設定的時間內 (預設為 60 秒) 未呼叫這些方法，佇列會假定接收者已失效。在此情況下，就視為接收者已呼叫 Abandon，讓其他接收者可以存取訊息。

請注意這裡發生的情形：相同的訊息可能傳遞兩次，或許是傳給兩個不同的接收者。使用服務匯流排佇列的應用程式對此必須有因應之道。為了輕鬆偵測重複訊息，每個訊息都有唯一的 MessageID 屬性，不論同一個訊息從佇列中讀取多少次，依預設此屬性維持不變。

佇列在許多情況下都很有用。即使兩個應用程式未同時都在執行，佇列仍可讓應用程式通訊，這尤其適用於批次和行動應用程式。如果佇列有多個接收者，由於傳送的訊息會襲捲這些接收者，此佇列也提供自動的負載平衡。


## 主題

佇列雖然很實用，但不見得是最適當的解決方案。有時，服務匯流排主題更適合。[圖 3](#Fig3) 闡明此概念。

<a name="Fig3"></a>![服務匯流排主題和訂用帳戶的圖表][topics-subs]
 
**圖 3：根據訂閱端應用程式所指定的篩選，應用程式可以接收部分或所有傳送至服務匯流排主題的訊息。**

主題在許多方面與佇列很類似。傳送者將訊息提交至主題，作法如同將訊息提交至佇列一樣，而這些訊息就像使用佇列時一樣，看起來完全相同。主要的差別在於，主題可讓每個接收端應用程式定義*篩選*，以建立其本身的訂用帳戶。所以，訂閱者只會看到符合此篩選的訊息。例如，[圖 3](#Fig3) 顯示一個傳送者、一個主題及三個訂閱者，而訂閱者各有其本身的篩選：

- 訂閱者 1 只接收包含屬性 *Seller="Ava"* 的訊息。
- 訂閱者 2 可接收包含 *Seller="Ruby"* 屬性及/或包含 *Amount* 屬性 (其值大於 100,000) 的訊息。Ruby 可能是銷售經理，因此想查看自己的銷售和所有人的銷售佳績。
- 訂閱者 3 將篩選設為 *True*，這表示接收所有訊息。例如，此應用程式可能負責維護稽核記錄，因此需要查看所有的訊息。

如同佇列一樣，主題的訂閱者也可以使用 ReceiveAndDelete 或 PeekLock 來讀取訊息。但與佇列不同，傳送至主題的單一訊息可以由多個訂閱者接收。每當多個應用程式可能都需要存取相同的訊息時，此方法很有用，這個方法通常稱為*發佈和訂閱*。每個訂閱者只要定義正確的篩選，即可只存取所需的訊息資料流部分。


## 轉送

佇列和主題都是透過代理人來提供單向非同步通訊。流量只往一個方向流動，傳送者和接收者之間並未直接連接。但如果不想要這種方式又該如何？ 假設應用程式同時需要傳送和接收訊息，或您可能希望應用程式之間直接連結，而不需要代理人來儲存訊息。為了處理此種案例，服務匯流排會提供轉送，如[圖 4](#Fig4) 所示。

<a name="Fig4"></a>![服務匯流排轉送的圖表][relay]
 
**圖 4：服務匯流排轉送在應用程式之間提供同步、雙向的通訊。**

關於轉送，最直接的問題就是：為什麼要使用轉送？ 即使我不需要佇列，為何要讓應用程式透過雲端服務來通訊，而不是直接互動？ 答案就是直接通訊並不如您想像地那麼簡單。

假設您想要連接兩個內部部署的應用程式，兩者都在公司資料中心內執行。每個應用程式都位於防火牆後面，且每個資料中心可能使用網路位址轉譯 (NAT)。防火牆會阻擋所有連接埠 (少數連接埠除外) 傳入的資料，而 NAT 意味著執行每個應用程式的電腦沒有固定的 IP 位址可供您從資料中心外部直接連接。需要一些額外的協助，否則透過公用網際網路來連接這些應用程式會有困難。

服務匯流排轉送可解決此問題。為了透過轉送進行雙向通訊，每個應用程式可以與服務匯流排建立輸出 TCP 連線，然後保持開啟。兩個應用程式之間的所有通訊都在這些連線上進行。因為每個連線都是從資料中心內建立，防火牆會允許流量傳入每個應用程式，而不需要開啟新的連接埠。此方法也克服 NAT 問題，因為每個應用程式在整個通訊期間的雲端中具有一致的端點。透過轉送來交換資料，應用程式得以解決難以通訊的問題。

應用程式需要 Windows Communication Foundation (WCF)，才能使用服務匯流排轉送。服務匯流排提供 WCF 繫結，可讓 Windows 應用程式輕鬆地透過轉送來互動。已使用 WCF 的應用程式通常只需要指定其中一個繫結，即可透過轉送來彼此通訊。然而，與佇列和主題不同，雖然可能從非 Windows 應用程式中使用轉送，但需要投入一些程式設計工作。沒有標準的程式庫可用。

與佇列和主題不同，應用程式不會明確建立轉送。反之，當需要接收訊息的應用程式對服務匯流排建立 TCP 連線時，將會自動建立轉送。連線中止時，就會刪除轉送。為了讓應用程式尋找特定接聽程式所建立的轉送，服務匯流排提供一個登錄，讓應用程式依名稱尋找特定的轉送。

當您需要應用程式進行直接通訊時，轉送就是最適合的解決方案。舉例來說，假設有一個在內部部署資料中心執行的飛機訂票系統，且必須從自助登機亭、行動裝置和其他電腦來存取此系統。所有這些系統上執行的應用程式，不論在何處執行，都可以依賴雲端的服務匯流排轉送來通訊。

## 事件中樞

事件中樞是可高度擴充的內嵌系統，每秒可處理數百萬事件，可讓您的應用程式處理和分析連接的裝置和應用程式所產生的大量資料。例如，您可以使用事件中樞收集車隊的即時引擎效能資料。收集到事件中樞後，您可以使用任何即時分析提供者或儲存體叢集轉換和儲存資料。如需事件中樞的詳細資訊，請參閱[事件中樞概觀][]。

## 摘要

建置完整的解決方案時一律會連接應用程式，而需要應用程式和服務彼此通訊的案例範圍會設定為隨著連到網際網路的應用程式和裝置日益增加而增加。服務匯流排提供雲端技術，透過佇列、主題、轉送和事件中樞來解決此問題，目的就是為了輕鬆實作此基本功能，並使之更加普及。

[svc-bus]: ./media/hybrid-solutions/SvcBus_01_architecture.png
[queues]: ./media/hybrid-solutions/SvcBus_02_queues.png
[topics-subs]: ./media/hybrid-solutions/SvcBus_03_topicsandsubscriptions.png
[relay]: ./media/hybrid-solutions/SvcBus_04_relay.png
[事件中樞概觀]: https://msdn.microsoft.com/library/azure/dn836025.aspx

<!---HONumber=July15_HO2-->