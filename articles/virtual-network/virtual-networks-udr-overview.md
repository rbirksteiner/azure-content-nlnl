<properties 
   pageTitle="使用者定義的路由和 IP 轉送概觀"
   description="了解 UDR 和 IP 轉送"
   services="virtual-network"
   documentationCenter="na"
   authors="telmosampaio"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="06/09/2015"
   ms.author="telmos" />

# 使用者定義的路由和 IP 轉送
當您在 Azure 中將虛擬機器 (VM) 新增到虛擬網路 (VNet) 時，您會注意到 VM 都能夠自動與其他網路通訊。您不需要指定閘道，即使 VM 位於不同子網路。VM 到公開網際網路的通訊同樣適用，甚至當存在 Azure 到您的資料中心的混合連線時，也適用於您的內部網路。

這個通訊流程是可能的，因為 Azure 會使用一連串系統路由來定義 IP 流量流動的方式。系統路由控制下列案例的通訊流程：

- 從同一子網路。
- 從 VNet 中的子網路到另一個子網路。
- 從 VM 到網際網路。
- 透過 VPN 閘道從 VNet 到另一個 VNet。
- 透過 VPN 閘道從 VNet 到您的內部網路。

下圖顯示 1 個 Vnet、2 個子網路和一些 VM，以及允許 IP 流量流動的系統路由的簡易安裝。

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure1.png)

雖然使用系統路由可自動加速您部署的流量，但是也有一些您希望透過虛擬設備控制封包路由的情況。您可以透過建立使用者定義的路由 (其指定流向指定子網路之封包的下個躍點，改為流向您的虛擬設備)，並啟用做為虛擬設備執行之 VM 的 IP 轉送。

下圖顯示範例為使用者定義的路由和 IP 轉送，其強制封包從前端子網路流向網際網路以通過虛擬設備，且所有從前端子網路流向後端子網路的封包皆通過不同設備。請注意，從後端子網路到前端子網路的流量仍會略過設備通過系統路由。

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure2.png)

## 路由
根據在實體網路上的每個節點定義的路由表，封包是透過 TCP/IP 網路路由傳送。路由表是個別路由的集合，用於決定根據目的地 IP 位址，在何處轉送封包。路由是由下列項目所組成：

- **位址前置詞**：路由所套用的目的地 CIDR，例如 10.1.0.0/16。
- **下一個躍點類型**：要接收封包的 Azure 躍點的類型。可能的值包括：
	- **本機**：代表本機虛擬網路。例如，如果您在相同的虛擬網路中有兩個子網路 (分別是 10.1.0.0/16 和 10.2.0.0/16)，路由表中每個子網路的路由的下一個躍點值為 [本機]。
	- **VPN 閘道**：代表 Azure S2S VPN 閘道。 
	- **網際網路**：代表 Azure 基礎結構所提供的預設網際網路閘道 
	- **虛擬應用裝置**：代表您新增至 Azure 虛擬網路的虛擬應用裝置。
	- **NULL**：代表黑洞。轉送至黑洞的封包將完全不會被轉送。
- **Nexthop 值**：下一個躍點值包含應該要將封包轉送到哪個 IP 位址。只有在下一個躍點類型為*虛擬應用裝置*所在的路由中，才允許下一個躍點值。

## 系統路由
虛擬網路中建立的每個子網路會自動與包含下列系統路由規則的路由表產生關聯：

- **本機 Vnet 規則**：此規則會自動針對虛擬網路中的每個子網路建立。它會指定 VNet 中 VM 之間的直接連結，沒有下一個中繼躍點。
- **內部規則**：此規則適用於所有內部位址範圍的流量，並使用 VPN 閘道做為下一個躍點目的地。
- **網際網路規則**：此規則處理所有公開網際網路的流量，並使用基礎結構網際網路閘道做為所有網際網路流量的下一個躍點。

## 使用者定義的路由
對於大部分的環境，您只需要已經由 Azure 所定義的系統路由。不過，您可能需要在特定情況下建立路由表，並新增一個或多個路由，例如：

- 透過內部部署網路到網際網路的強制通道。
- 在 Azure 環境中使用虛擬應用裝置。

在上述情況下，您必須建立一個路由表，並將使用者定義的路由新增到該路由表。您可以擁有多個路由表，而且相同的路由表可以與一個或多個子網路產生關聯。此外，每個子網路只能與單一路由資料表產生關聯。子網路中的所有 VM 和雲端服務都使用與該子網路相關聯的路由表。

子網路會依賴系統路由，直到路由表與子網路產生關聯為止。一旦關聯存在之後，在使用者定義的路由和系統路由之間，就會根據最長前置詞比對 (LPM) 完成。如果有多個符合相同 LPM 的路由，則會根據其來源，以下列順序選取路由：

1. 使用者定義的路由
1. BGP 路由 (使用 ExpressRoute 時)
1. 系統路由

若要了解如何建立使用者定義的路由，請參閱[如何在 Azure 中建立路由與啟用 IP 轉送](../virtual-networks-udr-how-to#How-to-manage-routes)。

>[AZURE.IMPORTANT]使用者定義的路由僅會套用至 Azure VM 和雲端服務。例如，如果您想要在內部部署網路與 Azure 之間新增防火牆虛擬應用裝置，您必須為您的 Azure 路由表建立一個使用者定義的路由，此路由會將前往內部部署位址空間的所有流量轉送到虛擬應用裝置。不過，來自內部部署位址空間的連入流量將會流經您的 VPN 閘道或直接到 Azure 環境的 ExpressRoute 電路，略過虛擬應用裝置。

## BGP 路由
如果您在內部部署網路與 Azure 之間有 ExpressRoute 連線，可以啟用 BGP，將路由從內部部署網路傳播至 Azure。這些 BGP 路由的使用方式與系統路由相同，也與每個 Azure 子網路中的使用者定義路由相同。如需詳細資訊，請參閱 [ExpressRoute 簡介](../expressroute-introduction)。

>[AZURE.IMPORTANT]您可以設定 Azure 環境透過內部部署網路使用強制通道，方法是，為使用 VPN 閘道做為下一個躍點的子網路 0.0.0.0/0 建立使用者定義的路由。不過，這只有在您使用的是 VPN 閘道，而不是 ExpressRoute 時，才有作用。若是 Expressroute，強制通道是透過 BGP 設定。

## IP 轉送
如上所述，建立使用者定義的路由的主要原因之一是將流量轉送到虛擬應用裝置。虛擬應用裝置無非就是一個 VM，可執行用來以某種方式處理網路流量的應用程式，例如防火牆或 NAT 裝置。

此虛擬應用裝置 VM 必須能夠接收未定址到本身的連入流量。若要讓 VM 接收定址到其他目的地的流量，您必須針對 VM 啟用 IP 轉送。這是 Azure 設定，不是客體作業系統中的設定。

若要了解如何啟用 Azure 中 VM 的 IP 轉送，請參閱[如何在 Azure 中建立路由與啟用 IP 轉送](../virtual-networks-udr-how-to#How-to-Manage-IP-Forwarding)。

## 後續步驟

- 了解如何[建立路由](../virtual-networks-udr-how-to#How-to-manage-routes)並將其關聯至子網路。
- 了解如何針對做為虛擬設備執行之 VM [啟用 IP 轉送](../virtual-networks-udr-how-to#How-to-Manage-IP-Forwarding)。 

<!---HONumber=July15_HO2-->