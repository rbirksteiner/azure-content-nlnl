<properties      
    pageTitle="在 DocumentDB 中分割資料 | Azure"      
    description="了解如何在 DocumentDB 中分割資料，以及使用雜湊、定界以及查閱分割的時機。"          
    services="documentdb"      
    authors="arramac"      
    manager="johnmac"      
    editor="monicar"      
    documentationCenter=""/> <tags      
    ms.service="documentdb"      
    ms.workload="data-services"      
    ms.tgt_pltfrm="na"      
    ms.devlang="na"      
    ms.topic="article"      
    ms.date="05/28/2015"      
    ms.author="arramac"/>

# 在 DocumentDB 中分割資料

[Microsoft Azure DocumentDB](../../services/documentdb/) 的設計可協助您達成快速、可預測的效能，並順暢地隨著您的應用程式成長向外延展。在 Microsoft，DocumentDB 用來賦與高延展性生產服務，像是可賦與 MSN Web 和行動應用程式套件的使用者資料存放區。

您也可以利用水平分割資料的方式 (通常稱為**分區化**的概念)，讓 DocumentDB 應用程式在儲存體和輸送量方面達到近乎無限延展。DocumentDB 帳戶可以利用線性方式，並透過可堆疊的單位成本 (簡稱**集合**) 調整。跨集合分割資料的最佳方式將取決於您的資料格式和存取模式。

閱讀本文後，您將能夠回答下列問題：

 - 什麼是雜湊、定界和查閱分割？
 - 使用每個分割技術的時機與原因？
 - 如何在 Azure DocumentDB 上建置分割應用程式？

本文將介紹一些有關分區化的概念。如果您準備好使用 DocumentDB.NET SDK 開始撰寫程式碼，以進行資料分割，請參閱[使用 DocumentDB.NET SDK 進行資料分割](documentdb-sharding.md)。

## 集合 = 分割

在我們更深入探索資料分割技術之前，務必了解集合是什麼以及不是什麼。您可能已經知道，集合是 JSON 文件的容器。DocumentDB 中的集合不只是邏輯容器，也是實體容器。它們是預存程序和觸發程序的交易界限，以及查詢和 CRUD 作業的進入點。每個集合會獲派保留數量的輸送量，且不會與相同帳戶中的其他集合共用。因此，您可以藉由新增更多集合，然後在它們之間散佈您的文件，在儲存體和輸送量方面向外延展您的應用程式。

集合與關聯式資料庫中的資料表不同。集合不會強制執行結構描述。因此，您可以在相同集合中儲存具有各種不同結構描述之不同類型的文件。不過，您可以選擇使用集合來儲存單一類型的物件，正如同您會對資料表進行的動作。最佳模型僅取決於資料一起出現在查詢和交易中的方式。

## 使用 DocumentDB 分割

使用 Azure DocumentDB 分割資料最常見的技術為定界分割、查閱分割和雜湊分割。通常您會在您的文件內指定單一的 JSON 屬性名稱做為您的分割金鑰，例如 "timestamp" 或 "userID"。在某些情況下，這可能會是內部的 JSON 屬性或文件的每個不同類型的不同的屬性名稱。

讓我們更進一步看看這些技巧。

## 定界分割

在定界分割中，分割是根據分割索引鍵是否在特定範圍內所指派。這常用於分割時間戳記屬性 (例如 eventTime 介於 2015 年 2 月 1 日與 2015 年 2 月 2 日之間)。

> [AZURE.TIP]如果您的查詢限制在分割索引鍵的特定範圍值，您應該使用定界分割。

## 查閱分割

在查閱分割中，分割是根據查閱對應指派，其指派不連續的分割值給特定的分割 (即分割或分區對應)。這常用於依區域分割 (例如：斯堪地那維亞的分割包含挪威、丹麥和瑞典)。

> [AZURE.TIP]在管理多租用戶應用程式中，查閱分割可提供最高程度的控制。您可以指派多個租用戶給單一集合、單一租用戶給單一集合，或甚至多個集合的單一租用戶。

## 雜湊分割

在雜湊分割中，分割是根據雜湊函式的值來指派，讓您在一些分割上平均分配要求和資料。這通常用於分割從大量不同用戶端產生或取用的資料，適合用來儲存使用者設定檔、類別目錄項目，以及 IoT ("Internet of Things") 遙測資料。

> [AZURE.TIP]每當要透過查閱分割列舉的實體太多時 (例如使用者或裝置)，以及實體間的要求率相當統一時，您應該使用雜湊分割。

## 選擇適當的分割技巧

那麼，最適合您的分割技巧為何？ 因資料類型和您的常用存取模式而定。在設計階段挑選適當的分割技巧，可讓您避免技術負債並處理資料大小和要求量的成長。

- **定界分割**通常用於日期的內容中，因為它提供簡易而自然的機制，所以能讓您依時間戳記進行過時分割。當查詢一般受限於時間範圍時，它也很有用，因為與分割界限對齊。 
- **查閱分割**可讓您以自然方式，將未排序且不相關的資料集 (例如，依照組織組成的群組租用戶，或依地理區域組成的州/省群組) 組成群組並加以組織。查閱也為在集合之間移轉資料提供更細微的控制。 
- **雜湊分割**適合用於統一要求的負載平衡，以有效運用您的佈建儲存體和輸送量。使用一致雜湊演算法可讓您在加入或移除分割時，將要移動的資料量降到最低。

您不需只選擇一個分割技巧。這些複合技巧可視案例發揮其效用。比方說，如果您在儲存車輛遙測資料，較理想的方法就是依時間戳記範圍分割裝置遙測資料，以獲得分割的便利管理能力的，其次依 VIN (汽車識別號碼) 分割，以向外延展而獲得輸送量 (範圍雜湊複合分割)。

## 開發分割的應用程式
在 DocumentDB 上開發分割的應用程式時，有三個要查看的主要設計區域。

- 路由您所建立和讀取 (包括查詢) 至正確集合的方式。
- 保存並擷取您的分割解決組態 (即分割對應) 的方式。
- 隨著資料和要求量的增加，新增/移除分割的方式。

讓我們仔細看看每個區域。

## 路由建立並查詢

對目前為止我們所討論的這三項技巧來說，路由文件建立要求很簡單。文件是從雜湊、查閱或與分割索引鍵對應的範圍值在分割上建立。

查詢和讀取一般應該限制於單一分割索引鍵，因此查詢可以展開傳送到僅符合的分割。但是，查詢所有資料需要跨多個分割展開要求，然後合併結果。請記住，有些查詢可能必須先執行自訂邏輯以合併結果，例如擷取前 N 個結果時。

## 管理分割對應

您也必須決定儲存分割對應的方式、您的用戶端將其載入並在變更時接收更新的方式，以及跨多個用戶端共用的方式。如果分割對應不常變更，您可以只是將它儲存在應用程式組態檔中。

若並非如此，您可以將其儲存任何持續性存放區中。我們已在生產環境中看到的一般設計模式是將分割對應序列化為 JSON，並將它們儲存在 DocumentDB 集合內。之後用戶端可以快取對應，以避免額外的來回行程，然後定期輪詢以取得變更。如果您的用戶端可能會修改分區對應，請確定它們使用一致的命名結構描述，以及使用開放式並行存取 (eTag) 以允許對分割對應的一致更新。

## 新增及移除分割

利用 DocumentDB，您可以隨時新增及移除建立集合，並用集合來儲存新的內送資料或重新平衡現有的集合上可用的資料。檢閱[限制](documentdb-limits.md)頁面以取得集合數目。您一律可以致電我們以增加這些限制。

利用查閱和定界分割新增及移除新分割很簡單。例如，新增新的地理區域或新時間範圍以取得最新資料，您只需將新分割附加到分割對應。將現有的分割分割成多個分割，或合併兩個分割需要多一點力氣。您需要進行兩個動作之一

- 將分區離線進行讀取。
- 將讀取路由至使用舊分割組態以及移轉期間的新分割組態的兩個分割。請注意，在移轉完成之前，無法提供交易和一致性層級的保證。

對於新增及移除分割而言，雜湊更為複雜。簡單的雜湊技巧將會造成隨機切換，而且需要移動大部分的資料。使用**一致雜湊**可確保只有一小部分資料需要移動。

新增新分割而不需要移動資料的相當簡單的方法是將您的資料「溢出」至全新的集合中，然後對舊的和新的集合展開傳送要求。不過，這種方法應該只能用在罕見的情況下 (例如在尖峰時間工作負載溢出，以及在可以移動資料之前暫時保存資料)。

## 後續步驟
在本文中，我們將介紹一些您如何使用 DocumentDB 分割資料的常見技巧，以及使用哪些技巧或的技巧的組合的時機。

-   接著，請查看本[文章](documentdb-sharding.md)，了解如何搭配 DocumentDB SDK 使用分割解析程式，以進行資料分割。 
-   下載其中一個[支援的 SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx)
-   如果您有任何問題，請透過 [MSDN 支援論壇](https://social.msdn.microsoft.com/forums/azure/home?forum=AzureDocumentDB)與我們連絡。
   


 

<!---HONumber=July15_HO1-->