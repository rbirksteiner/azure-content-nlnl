<properties
   pageTitle="延展性檢查清單 | Microsoft Azure"
   description="為 Azure 自動調整設計考量的延展性檢查清單指引。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="04/28/2015"
   ms.author="masashin"/>

# 延展性檢查清單

![](media/best-practices-scalability-checklist/pnp-logo.png)

## 服務設計
- **分割工作負載**。將部分程序設計為離散與可分解狀態，並在遵循分離特定需求功能之一般規則與單一責任原則的情況下，將各部分的大小減至最小。如此一來，散佈元件部分時，即可充分運用每個計算單位 (例如角色或資料庫伺服器)，並能新增特定資源的額外執行個體，輕鬆調整應用程式。如需詳細資訊，請參閱「[計算分割指引](https://msdn.microsoft.com/library/dn568099.aspx)」。
- **調整設計**。應用程式可藉由調整功能增加與減少角色、佇列和其他所使用之服務的執行個體數目，因應多變的負載。不過，設計應用程式時也必須考量到這一點。例如，該應用程式與其使用的服務必須處於無狀態，才能將要求路由至任何執行個體，以避免在新增或移除特定執行個體時對目前使用者造成不良影響。新增或移除執行個體時，也必須實作執行個體的組態或自動偵測，如此應用程式的程式碼才能執行必要的路由。例如， Web 應用程式可能會以循環配置資源的方式使用一組佇列，將要求路由至以背景工作角色執行的背景服務。Web 應用程式必須要能偵測佇列數目的變化，才能成功地路由要求並平衡應用程式上的負載。
- **以單位進行調整**。規劃新增其他資源，以因應成長。您應該了解每個資源的調整上限，並利用分區化或分解方式來突破這些限制。根據定義完善的資源組決定系統縮放單位。在整個系統某部分缺乏資源所加諸的限制下，能夠輕鬆套用相應放大作業，並對應用程式產生較少負面影響。例如，新增 x 個 Web 和背景工作角色可能需要 y 個額外佇列和 z 個儲存體帳戶，以處理這些角色所產生的額外工作負載，因此一個縮放單位可能包含 x 個 Web 和背景工作角色、_y_ 個佇列和 _z_ 個儲存體帳戶。應用程式應設計為能藉由新增一或多個縮放單位輕鬆調整。
- **避免用戶端親和性**。可能的話，請確認應用程式不需親和性，以便將要求路由至任一執行個體，而執行個體的數量並不重要。這也可避免進行儲存、擷取與維護每位使用者狀態資訊所產生的額外負荷。
- **利用平台自動調整功能**。通常會優先使用裝載平台支援的自動調整功能 (如 Azure Autoscaling)，只有在內建機制無法滿足需求的情況下才會使用自訂或第三方機制 。 請儘可能使用排程的調整規則，確保資源可正常使用而不會造成啟動延遲，但適度地將重新啟動自動調整新增至規則中，以在必要時因應非預期的變更。您可使用服務管理 API 中的自動調整作業來微調自動調整功能，並將自訂計數器新增至 Web 入口網站組態選項未提供的規則中 。如需詳細資訊，請參閱「[自動調整指引](best-practices-auto-scaling.md)」頁面。
- **卸載密集 CPU/IO 工作作為背景工作**。若已預期對服務的要求需要較長的執行時間或吸收大量資源，請卸載此要求的處理程序並轉為個別工作。利用背景工作角色或背景工作 (依裝載平台而定) 來執行這些工作。這項策略可讓服務繼續接收更多要求，並能保持正常回應。如需詳細資訊，請參閱「[背景工作指引](best-practices-background-jobs.md)」(英文)。
- **分散背景工作的工作負載**。當背景工作很多，或工作需要大量時間或資源，請將工作分散到多個計算單位 (例如背景工作角色或背景工作)。 [競爭取用者模式](https://msdn.microsoft.com/library/dn568101.aspx)則提供了一個可能的解決方案。
- **考慮採用_無共用_架構**。無共用架構使用獨立且自給自足的節點，完全不會出現如共用服務或儲存體的爭用情況。理論上，這類系統幾乎可以無限期地調整。雖然一般而言，完全無共用架構的方法對大部分的應用程式來說並不實用，卻可能因此有機會設計更好的延展性。例如，避免使用伺服器端工作階段狀態、用戶端親和性與資料分割，都是採用無共用架構的絕佳範例。

## 資料管理

- **使用資料分割**。將資料分割至多個資料庫和資料庫伺服器，或將應用程式設計為使用提供明確分割功能的資料儲存體服務 (範例包括 Azure SQL Database Elastic Scale，以及 Azure 資料表儲存體)。此方法有助於達到最佳效能，使調整更加輕鬆自如。資料分割技術有許多種，例如水平資料分割、垂直資料分割與功能資料分割，您可加以合併使用以達到最佳效能，上至提升的查詢效能、較簡單的延展性、更佳的管理靈活度、更高的可用性，下至比對存放區類型與其保存的資料。此外，請考慮針對不同類型的資料使用不同類型的資料存放區，並根據針對特定資料類型最佳化的程度，來決定使用的類型。 這可能包括使用資料表儲存體、文件資料庫，或改用資料欄系列資料存放區，以及關聯式資料庫。如需詳細資訊，請參閱「[資料分割指引](best-practices-data-partitioning.md)」。
- **最終一致性的設計**。藉由減少或移除同步處理分割至多個存放區之相關資料的時間，最終一致性得以改善延展性。代價是讀取該資料時，有時會出現不一致的現象，而有些寫入作業也可能會導致衝突。最終一致性最適用於同筆資料讀取頻率高但寫入頻率低的情況。如需詳細資訊，請參閱「[資料一致性指引](#insertlink#)」。
- **減少元件與服務之間的多對話互動**。避免將服務設計成_多對話_互動，多對話表示應用程式必須對服務發出多次呼叫 (每次傳回少量資料)，而不是發出單一呼叫一次傳回所有資料。可能的話，當發出呼叫的對象服務或元件有明顯延遲現象時，將數個相關作業結合成單一要求 。例如，使用資歷庫中的預存程序來封裝複雜的邏輯，並減少來回傳送與資源鎖定的次數。
- **使用佇列來調節高速資料寫入負載**。服務需求激增會使服務超過負荷，且導致提升失敗。若要避免這個問題，請考慮實作「[佇列型負載調節模式](https://msdn.microsoft.com/library/dn589783.aspx)」。使用做為所叫用之工作與服務之間緩衝區的佇列，讓間歇性大量負載更加順暢，否則可能導致服務失敗或工作逾時。
- **最小化資料存放區的負載**。資料存放區通常是個處理瓶頸、昂貴資源，且不易相應放大。可能的話，移除資料存放區的邏輯 (例如處理 XML 文件或 JSON 物件)，並於應用程式內執行處理。例如，不要將 XML 傳送至資料庫 (除了做為儲存體的不透明字串)，而是在應用程式層將該 XML 序列化或反序列化，並以資料存放區原生型式傳送。一般而言，將應用程式相應放大會比資料存放區簡單地多，因此您應嘗試在應用程式內儘可能執行大量運算處理。
- **最小化資料擷取量**。指定資料行並使用準則來選取資料列，只擷取您所要求的資料。請使用資料表值參數和適當的隔離層級。使用 ETags 來避免擷取不必要的資料。
- **積極使用快取**。儘可能使用快取，為產生或傳遞資料的資源和服務減少負載。快取通常適用於相對靜態的資料，或需要大量處理才能取得的資料。快取應在應用程式各層的適當層級中進行，包括資料存取與 UI 生成。如需詳細資訊，請參閱「[快取指引](best-practices-caching.md)」。
- **處理資料成長與保留**。應用程式所儲存的資料量會隨著時間成長。這樣的成長會增加儲存體成本，並增加存取資料時的延遲，這也會影響應用程式輸送量和效能。您可定期封存一些不再需要存取的舊資料，或將很少存取的資料移至長期儲存體，即使存取延遲因而增加，長期儲存體仍較為經濟實惠。
- **使用高效二進位格式最佳化 DTO**。資料傳輸物件會在應用程式各層之間來回傳送多次，因此儘可能縮減其大小，可減少資源與網路的負載。不過，請在縮減大小以及將資料轉換為使用資料所在位置之所需格式的額外負荷間取得平衡，並採用具有最大互通性的格式，以便輕鬆重複使用元件。
- **設定快取控制**。將應用程式設計和設定為使用輸出快取或片段快取，儘可能將處理負載最小化。
- **啟用用戶端快取**。Web 應用程式應於可快取的內容上啟用快取設定。這部分通常預設為停用。設定伺服器來傳遞適當的快取設定標頭，以啟用 Proxy 伺服器與用戶端內容的快取。
- **使用 Azure blob 儲存體與 CDN 來減少應用程式的負載**。請考慮將靜態或相對靜態的公用內容 (例如影像、資源、指令碼和樣式表) 儲存在 blob 儲存體。這種方法能減輕應用程式內，因每個要求動態產生內容所導致的負載。此外，請考慮使用 CDN 來快取此內容，並傳遞給用戶端。使用 CDN 可改善用戶端效能，因為內容是經由地理位置最近且包含 CDN 快取的資料中心所傳遞。如需詳細資訊，請參閱「[CDN 指引](best-practices-cdn.md)」。

- **最佳化與微調 SQL 查詢和索引**。某些 T-SQL 陳述式或建構可能會影響效能，可藉由最佳化預存程序中的程式碼來降低影響。例如，應避免在比較 **datetime** 常值之前，將 **datetime** 類型轉換成 **varchar**，而改用日期/時間比較功能。缺少適當的索引可能會減緩查詢執行速度。若您使用物件/關聯式對應 (ORM) 架構，請了解其運作方式，以及對於資料存取層效能的影響。如需詳細資訊，請參閱「[查詢微調](https://technet.microsoft.com/library/ms176005.aspx)」。
- **考慮去正規化資料**。資料正規化有助於避免重複和不一致。不過，維護多個索引、檢查參考完整性、多重存取小塊資料以及聯結資料表來重組資料，皆會造成額外負荷並影響效能。請考慮是否接受一些額外儲存體磁碟區和重複，以減少資料存放區的負載。此外，請考慮是否依賴應用程式本身 (通常較易於調整) 來取代工作，例如管理參考完整性，以減少資料存放區的負載。如需詳細資訊，請參閱「[資料分割指引](https://github.com/mspnp/azure-guidance/blob/master/Data%20partitioning.md)」。

## 服務實作
- **使用非同步呼叫**。當資源或服務存取受限於 I/O 或網路頻寬或有明顯的延遲時，儘可能使用非同步程式碼，以避免鎖定呼叫執行緒。使用以工作為基礎的非同步模式來實作非同步作業。如需詳細資訊，請參閱 Microsoft 網站上的「[以工作為基礎的非同步模式 (TAP)](https://msdn.microsoft.com/library/hh873175.aspx)」頁面。
- **避免鎖定資源，並改用開放式方法**。永不鎖定存取資源，例如儲存體或其他有明顯延遲的服務，因為這正是導致效能不佳的主要原因。請務必使用開放式方法來管理並行作業，例如寫入儲存體，並使用儲存體的功能來管理衝突。在分散式應用程式中，資料可能到最後才能保持一致。
- **壓縮高度可壓縮資料來通過高延遲、低頻寬的網路**。以 Web 應用程式來說，應用程式所產生並透過網路所傳遞最大量的資料，大部分都是傳送給客戶端要求的 HTTP 回應。尤其對於靜態內容而言，HTTP 壓縮可大幅度減少資料量。這樣可以節省成本，也能減少網路負載，不過壓縮動態內容也會對伺服器造成稍高的負載。在其他更一般的環境中，資料壓縮可減少資料傳輸量，將傳輸時間與成本降到最低，但壓縮或解壓縮過程卻會增加額外負荷。此方法應該只在效能上有明顯實質效益的情況下使用。其他序列化方法，例如 JSON 或二進位，可在減少承載的同時對效能也有較低的影響，而 XML 則是會加重影響。
- **最小化連線與資源使用的時間**。僅在需要連線和資源時維護使用。例如，連線越慢開啟越好，並允許他們儘快返回連線集區。資源越慢取得越好，處置速度越快越好。
- **最小化所需的連線數目**。服務連線會吸收資源。儘可能限制所需數目，並確保能儘量重複使用現有連線。例如，在執行驗證之後，適當使用模擬來執行做為特定身分識別的程式碼。這樣有助於重複使用連線來充分運用連線集區。  

	> [AZURE.NOTE]
- **以批次方式傳送要求來最佳化網路使用**。例如，在存取佇列時以批次方式傳送和讀取訊息，並在存取儲存體或快取時，以批次方式執行多重讀取或寫入。藉由減少網路呼叫次數，有助於最大化服務與存放區的效率。
- 儘可能**避免要求儲存伺服器端工作階段狀態**。伺服器端工作階段狀態管理通常需要用戶端親和性 (路由每個要求至相同的伺服器執行個體)，這會影響系統的調整能力。在理想的情況下，您應將用戶端使用的伺服器設計成無狀態。不過，若應用程式必須維持工作階段狀態，請將敏感資料或大量客戶端資料，儲存在所有執行個體皆可存取的分散式伺服器端快取中。
- **最佳化資料表儲存體結構描述**。使用如 Azure 資料表儲存體這種需要每個查詢傳送與處理資料表與資料行名稱的資料表儲存體，請考慮使用較短名稱以減少額外負荷。不過，即使刻意使用精簡名稱，也別犧牲可讀性或可管理性。
- **運用 TPL 執行非同步作業**。工作平行程式庫 (TPL) 讓您輕鬆地寫入執行 I/O 繫結作業的非同步程式碼。儘可能使用 _ConfigureAwait(false)_，以排除特定同步處理內容上接續的相依性，並減少發生執行緒死結的機會。
- **在部署期間或在應用程式啟動時建立資源相依性**。避免重複呼叫測試資源存在與否的方法，若資源不存在，請建立資源 (方法如 Azure Storage Client Library 中的 _CloudTable.CreateIfNotExists_ 和 _CloudQueue.CreateIfNotExists_ 皆遵循這個模式)。若在每次存取儲存體資料表或儲存體佇列前叫用這些方法，會造成大量的額外負荷 。因此，請於應用程式進行部署或第一次啟動時建立所需資源 (可在 Web 或背景工作角色的啟動程式碼中，對每個資源 _CreateIfNotExists_ 發出單一呼叫)。 不過，若您的程式碼嘗試存取不存在的資源，請務必處理可能發生的例外狀況。如果出現這些情況，您應記錄例外狀況，並儘可能警示操作員提醒資源遺漏。在某些情況下，建立遺漏資源，使其成為例外狀況處理程式碼的一部分可能較為恰當，但您應謹慎採用此方法，因為缺少資源可能表示程式設計錯誤 (例如資源名稱拼寫錯誤)，或其他基礎結構層級的問題。
- **使用輕量型架構**。謹慎選擇 API 與您使用的架構，以最小化應用程式的資源使用情況、執行時間以及整體負載。例如，使用 Web API 來處理服務要求，可減少應用程式使用量且加快執行速度，但這個方法可能比較不適合需要 WCF 額外功能的進階案例。
- **考慮最小化服務帳戶數目**。例如，使用特定帳戶存取會造成連線限制，或在連線較少情況下表現較佳的資源或服務。這個方法很常用在如資料庫的服務上，但由於原始使用者模擬的關係，會影響到正確稽核作業的能力。
- 在開發期間**執行效能分析與負載測試**，視為測試常式的一部分，並在確定發行之前，確認應用程式可視需要執行或調整。這個測試應在與生產平台相同的硬體類型上執行，並使用相同的資料類型、數量和使用者負載，因為在生產過程中也會遇到相同情況。如需詳細資訊，請參閱 Microsoft 網站上的「[測試雲端服務的效能](https://msdn.microsoft.com/library/azure/hh369930.aspx)」頁面。

<!---HONumber=62-->