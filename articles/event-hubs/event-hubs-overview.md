<properties 
   pageTitle="事件中心概觀"
   description="Azure 事件中樞的簡介和概觀。"
   services="event-hubs"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="" />
<tags 
   ms.service="event-hubs"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="tbd"
   ms.date="06/09/2015"
   ms.author="sethm" />

# Azure 事件中樞概觀

許多現代化解決方案的目的在於提供彈性的客戶體驗，抑或是透過不間斷的意見反應和自動化遙測來改善產品。如何安全可靠地處理多個並行發佈者發佈之龐大資訊遂成為這類解決方案必須克服的難題。Microsoft Azure 事件中樞是受管理的平台服務，它能在各式各樣的案例中提供大規模資料攝取的基礎。這類案例包括行動應用程式中的行為追蹤、來自 Web 伺服陣列的流量資訊、遊戲機遊戲中的遊戲內部事件擷取，或是從產業用機器或連接之車輛收集而來的遙測資料。對於事件中樞在解決方案架構中扮演的通用角色，其作用在於成為事件管線的「大門」(通常稱為*事件擷取器*)。事件擷取器是介於事件產生者和事件取用者之間的元件或服務，它能將事件串流的生產與這些事件的取用彼此脫鉤。

![事件中樞](./media/event-hubs-overview/IC759856.png)

Azure 事件中樞是事件處理服務，它能提供大規模進入雲端的事件和遙測入口，並具備低延遲和高可靠性等特性。當搭配其他下游服務時，該服務特別適合用於應用程式檢測、使用者經驗或工作流程處理及物聯網 (IoT) 案例。事件中樞提供訊息串流處理能力，雖然它是類似佇列和主題的實體，不過擁有非常不同於傳統企業傳訊的特性。企業傳訊案例通常需要一些複雜的功能，如排序、無效信件處理、交易支援和強式傳遞保證，而事件攝取的主要考量是高輸送量和事件串流的處理彈性。因此，Azure 事件中樞功能與服務匯流排主題的相異之處在於，這些功能乃極度偏向高輸送量和事件處理案例。就本質上來說，事件中樞不會實作一些可用於主題的傳訊功能。如果您需要這些功能，主題仍是最佳選擇。

事件中樞的建立位置為服務匯流排的命名空間層級，與佇列和主題相似。事件中樞使用 AMQP 和 HTTP 來做為主要的 API 介面。下圖指出事件中樞與服務匯流排之間的關係。

![事件中樞](./media/event-hubs-overview/IC741188.png)

## 概念概觀

事件中樞可透過分割取用者模式提供訊息串流。佇列和主題使用[競爭取用者](https://msdn.microsoft.com/library/dn568101.aspx)模型，在該模型內每一位取用者都會嘗試讀取相同的佇列或資源。這樣子的資源競爭最終會導致串流處理應用程式過於複雜且規模受限。事件中樞使用分割取用者模式，在該模式中每位取用者只會讀取訊息串流的特定子集或資料分割。此模式能水平擴充事件處理規模，並提供佇列和主題缺少的其他串流導向功能。

### 分割數

資料分割是經過排序且保存在事件中樞內的事件序列。當較新的事件送達時，系統會將它們加入序列的結尾。您可以將資料分割視為一種「認可記錄」。

![事件中樞](./media/event-hubs-overview/IC759857.png)

資料分割能保留資料，直到在事件中樞層級設定的保留時間結束為止。這項設定適用於事件中樞內的所有資料分割。事件會隨著時間經過而到期，因此您無法明確地予以刪除。事件中樞包含多個資料分割。每個資料分割互不相關，且包含自己的資料序列。因此，各個資料分割的成長速率通常不盡相同。

![事件中樞](./media/event-hubs-overview/IC759858.png)

資料分割數目是在事件中樞建立時指定的，該值必須介於 8 到 32 之間。資料分割是一種資料組織機制，它與取用應用程式所需之下游平行處理原則程度之間的相關性較事件中樞輸送量來得大。如此一來，您在事件中樞內選擇的資料分割數目，將與預期擁有的並行讀取器數目直接相關。待事件中樞建立後，資料分割計數便無法變更，因此您應該從長期的預期規模來考量這個數值。您可以透過連絡 Azure 服務匯流排團隊來增加 32 的資料分割限制。

雖然資料分割可加以識別，並且可以直接傳送，但是在一般情況下最好避免將資料傳送到特定資料分割。相反地，您可以使用導入[事件發佈者](#Event-publisher)和[發佈者原則](#Capacity-and-security)區段的較高層級建構。

在事件中樞的內容中，訊息意指*事件資料*。事件資料包含事件本文、使用者定義屬性包，以及與事件相關的各種中繼資料，例如在資料分割中的位移和在串流序列中的編號。資料分割填滿著一連串的事件資料。

## 事件發佈者

將事件或資料傳送到事件中樞的任何實體都是*事件發佈者*。事件發佈者可以使用 HTTPS 或 AMQP 1.0 發佈事件。事件發佈者使用共用存取簽章 (SAS) 權杖來向事件中樞辨識自己的身分，而且可以擁有唯一的身分識別。它也根據案例需求使用一般 SAS 權杖。

如需使用 SAS 的詳細資訊，請參閱[使用服務匯流排的共用存取簽章驗證](https://msdn.microsoft.com/library/dn170477.aspx)。

### 常見的發佈者工作

本節描述常見的事件發佈者工作。

#### 取得 SAS 權杖

共用存取簽章 (SAS) 是事件中樞的驗證機制。服務匯流排能在命名空間和事件中樞層級提供 SAS 原則。SAS 權杖可自 SAS 金鑰產生，它是經過特定格式編碼的 URL SHA 雜湊。透過金鑰 (原則) 的名稱和權杖，服務匯流排可以重新產生雜湊，藉此驗證傳送者。一般而言，建立的事件發佈者 SAS 權杖只具備特定事件中樞的**傳送**權限。此 SAS 權杖 URL 機制是導入發佈者原則之發佈者識別的基礎。如需使用 SAS 的詳細資訊，請參閱[使用服務匯流排的共用存取簽章驗證](https://msdn.microsoft.com/library/dn170477.aspx)。

#### 發佈事件

您可以透過 AMQP 1.0 或 HTTPS 來發佈事件。服務匯流排提供 [EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx) 類別，以供您從 .NET 用戶端將事件發佈到事件中樞。對於其他執行階段和平台，您可以使用任何 AMQP 1.0 用戶端 (如 [Apache Qpid](http://qpid.apache.org/))。您可以單獨發佈事件，或以批次方式進行。不論是單一事件或批次，單次發行 (事件資料執行個體) 的上限為 256KB。發佈大於此限制的事件會導致錯誤。發佈者最好別顧慮事件中樞內的資料分割，他們只需要指定*資料分割索引鍵* (下一節將加以介紹)，或透過其 SAS 權杖指定身分識別即可。

使用 AMQP 或 HTTPS 的選擇因使用案例而異。除了傳輸層級安全性 (TLS) 或 SSL/TLS 之外，AMQP 還需要建立持續性的雙向通訊端。這是需要耗費大量網路流量的作業，不過只會發生在 AMQP 工作階段的開始。HTTPS 的初始額外負荷較低，但每個要求都需要額外的 SSL 額外負荷。對於經常發佈事件的發佈者，AMQP 能帶來可觀的效能、延遲及輸送量節約效益。

### 資料分割索引鍵

資料分割索引鍵是用來將內送事件與特定資料分割對應，以利組織資料的值。資料分割索引鍵是由傳送者提供的值。系統會將它傳遞到事件中樞，並透過靜態雜湊函式加以處理，最終會建立資料分割指派。如果您在發佈事件時未指定資料分割索引鍵，系統會使用循環配置資源指派。在使用資料分割索引鍵時，事件發佈行者只會知道資料分割索引鍵，他們不會知道事件發佈的目的地資料分割。這個索引鍵和資料分割脫鉤的機制，讓傳送者不需要知道太多有關事件下游處理和儲存的詳情。資料分割索引鍵對組織資料以進行下游處理來說很重要，但基本上它與資料分割本身無關。每部裝置或每位使用者的唯一身分識別能成為有效的資料分割索引鍵，不過像地理位置之類的其他屬性也能用來將相關事件歸納成一個資料分割。下圖顯示使用資料分割索引鍵釘選到資料分割的事件傳送者。

![事件中樞](./media/event-hubs-overview/IC759859.png)

Azure 事件中樞能確保所有共用相同資料分割索引鍵值的事件依序傳遞到同一個資料分割。最重要的是，如果將資料分割索引鍵與下節所述的發佈者原則搭配使用，發佈者的身分識別與資料分割索引鍵的值必須相符，否則便會發生錯誤。

### 事件取用者

讀取事件中樞之事件資料的任何實體都是事件取用者。所有事件取用者都會透過取用者群組中的資料分割讀取事件串流。每個資料分割一次只能有一個作用中的讀取器。所有事件中樞取用者都能透過 AMQP 1.0 工作階段連線，而系統會在事件可供取用時於工作階段期間傳遞。用戶端不需要輪詢資料可用性。

#### 用戶群組

事件中樞的發佈/訂閱機制可透過取用者群組啟用。取用者群組是檢視整個事件中樞 (狀態、位置或位移) 的窗口。取用者群組能讓多個取用應用程式擁有自己的事件串流檢視，以及按照自己的步調及運用自己的位移自行讀取串流。在串流處理架構中，每個下游應用程式等同於一個取用者群組。如果您想要將事件資料寫入長期存放區，該存放裝置寫入器應用程式即是取用者群組。複雜事件處理是由另一個獨立的取用者群組來執行。您只能透過取用者群組來存取資料分割。每個事件中樞永遠有一個預設的取用者群組，而您可以為標準層事件中樞建立最多 20 個取用者群組。

以下是取用者群組 URI 慣例的範例：

	//<my namespace>.servicebus.windows.net/<event hub name>/<Consumer Group #1>
	//<my namespace>.servicebus.windows.net/<event hub name>/<Consumer Group #2>

下圖顯示取用者群組內的事件取用者。

![事件中樞](./media/event-hubs-overview/IC759860.png)

#### 串流位移

位移是事件在資料分割內的位置。您可以將位移視為用戶端指標。位移是事件的位元組編號。這可讓事件取用者 (讀取器) 在事件串流中指定某個點，以便從該點開始讀取事件。您可以指定時間戳記或位移值等形式的位移。取用者需負責將自己的位移值儲存在事件中樞服務之外。

![事件中樞](./media/event-hubs-overview/IC759861.png)

在資料分割內，每個事件都含有一個位移。取用者能使用此位移來針對指定資料分割指出事件序列中的位置。當讀取器連接時，系統能以數值或時間戳記值等形式將位移傳遞給事件中樞。

#### 檢查點

*設立檢查點*是讀取器在資料分割事件序列中標記或認可其位置的程序。設立檢查點是取用者的責任，這項作業會在取用者群組內依照資料分割來進行。這表示在每個取用者群組內，每個資料分割讀取器必須追蹤自己目前在事件串流中的位置，而當它們認為資料串流完成時，可以通知服務。如果讀取器與資料分割中斷連線，當它重新連線時，會從該取用者群組中該資料分割最後一個讀取器先前提交的檢查點開始讀取。當讀取器連線時，它會將此位移傳遞給事件中樞，以指定要開始讀取的位置。如此一來，檢查點能成為下游應用程式標記事件「完成」的方法，也能針對在不同機器上執行的讀取器提供容錯移轉發生時的恢復功能。由於系統會保留事件資料，直到在建立事件中樞時指定的保留間隔結束為止，因此您只要在設立檢查點的程序中指定較低的位移，便能傳回較舊的資料。透過這項機制，檢查點可提供容錯移轉彈性，以及實現受控制的事件串流重播。

#### 常見的取用者工作

本節描述事件中樞事件取用者或讀取器的常見工作。所有事件中樞取用者均透過 AMQP 1.0 連線。AMQP 1.0 是工作階段和狀態感知的雙向通訊通道。每個資料分割都有 AMQP 1.0 連結工作階段，其有助於資料分割所隔離之事件的傳輸。

##### 連接資料分割

為了要取用事件中樞的事件，取用者必須連接資料分割。如先前所述，您一律要透過取用者群組存取資料分割。如資料分割取用者模型所規範，每個取用者群組內的每個資料分割上一次只能有一個作用中的讀取器。為了協調讀取器與特定資料分割的連線，常見的做法是在直接連接資料分割時使用租用機制。如此一來，取用者群組中的每個資料分割便可能只會有一個作用中的讀取器。管理讀取器在序列中的位置是一項重要工作，您可以透過檢查點來達成。.NET 用戶端可以使用 [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) 類別來簡化這項功能。[EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) 是智慧型的取用者代理程式，我們將在下一節多加描述。

##### 讀取事件

在開啟特定資料分割的 AMQP 1.0 工作階段和連結後，事件中樞服務會將事件傳遞至 AMQP 1.0 用戶端。相較於以提取為基礎的機制 (如 HTTP GET)，這個傳遞機制能產生更高的輸送量和較低的延遲。將事件傳送到用戶端時，每個事件資料執行個體都包含如位移和序號等有助於在事件序列上設立檢查點的重要中繼資料。

![事件中樞](./media/event-hubs-overview/IC759862.png)

利用最能有效管理串流處理進度之方法來管理位移是使用者的責任。

## 容量和安全性

事件中樞是可高度擴充的平行串流入口架構。因此，當您在根據事件中樞調整解決方案之大小和規模時，請將幾個重要層面納入考量。這些容量控制考量的第一項是下一節所述的*輸送量單位*。

### 輸送量單位

事件中樞的輸送量容量受輸送量單位所控制。輸送量單位是預先購買的容量單位。一個輸送量單位包括：

- 輸入：最高每秒 1MB 或每秒 1000 個事件。

- 輸出：最高每秒 2MB。

系統會根據您購買之輸送量單位數目所提供的容量數來調節輸入。傳送超過以上數量的資料會產生「超出配額」例外狀況。該數量為每秒 1MB 或 1000 個事件，以先達到的限制為準。輸出不會產生節流例外狀況，不過須受限於您購買之輸送量單位所提供的資料傳輸數量：每個輸送量單位每秒 2MB。如果您收到發佈速率例外狀況或輸出速率低於預期，請務必查看針對建立事件中樞之命名空間所購買的輸送量單位數目。若要取得更多的輸送量單位，您可以前往 Azure 管理入口網站之 **[設定]** 索引標籤的 **[命名空間]** 頁面調整設定。您也可以使用 Azure API 來變更此項設定。

雖然資料分割屬於資料組織概念，不過輸送量單位卻純粹是容量概念。輸送量單位是以每小時計費，採預先購買制。一經購買，您至少必須支付一個小時的輸送量單位費用。您最多可以為一個服務匯流排命名空間購買 20 個輸送量單位，且 Azure 帳戶有 20 個輸送量單位的限制。指定命名空間內的所有事件中樞會共用這些輸送量單位。

我們不一定有足夠的輸送量單位供您立即購買，不過我們會盡可能為您佈建。如果您需要特定容量，建議您事先購買輸送量單位。如果您需要 20 個以上的輸送量單位，可以連絡 Microsoft Azure 服務匯流排支援，在訂定承諾的前提下以 20 個區塊為單位購買更多輸送量單位，直到首次達到 100 個輸送量單位為止。之後，您還可以購買以 100 個輸送量為單位的區塊。

建議您謹慎地取得輸送量單位和資料分割之間的平衡，讓事件中樞發揮最佳規模效益。每個資料分割有一個輸送量單位的規模上限。輸送量單位的數目應該要小於或等於事件中樞內的資料分割數目。

如需詳細定價資訊，請參閱[事件中樞定價](http://azure.microsoft.com/pricing/details/event-hubs/)。

### 發佈者原則

事件中樞可讓您透過*發佈者原則*更精確地控制事件生產者。發佈者原則是一組執行階段功能，其設計乃是為了促進大量獨立事件產生者的運作。有了發佈者原則，當每位發佈者使用下列機制將事件發佈到事件中樞時，都能使用自己的唯一識別碼：

	//<my namespace>.servicebus.windows.net/<event hub name>/publishers/<my publisher name>

您不需要事先建立發佈者名稱，不過這些名稱必須符合發佈事件時使用的 SAS 權杖，以確保發佈者身分識別是獨立的。如需 SAS 的詳細資訊，請參閱[使用服務匯流排的共用存取簽章驗證](https://msdn.microsoft.com/library/dn170477.aspx)。在使用發佈者原則時，系統會將 **PartitionKey** 值設定為發佈者名稱。若要正常運作，這些值必須相符。

## 摘要

Azure 事件中樞提供超規模事件和遙測處理服務，該服務適用於任何規模的通用應用程式和使用者工作流程監視。藉由提供大規模的低延遲發佈訂閱功能，事件中樞能成為引進巨量資料的途徑。透過以發佈者為基礎的身分識別和撤銷清單，您可以將這些功能延伸到一般的物聯網案例。如需開發事件中樞應用程式的詳細資訊。請參閱[事件中樞程式設計指南](https://msdn.microsoft.com/library/dn789972.aspx)。

## 後續步驟

既然您已了解事件中樞的相關概念，您可以移至下列案例：

- 開始使用[事件中樞教學課程]。
- [使用事件中樞的完整範例應用程式]。
- 使用服務匯流排佇列的[佇列訊息解決方案]。

[事件中樞教學課程]: service-bus-event-hubs-csharp-ephcs-getstarted.md
[使用事件中樞的完整範例應用程式]: https://code.msdn.microsoft.com/windowsazure/Service-Bus-Event-Hub-286fd097
[佇列訊息解決方案]: ../cloud-services-dotnet-multi-tier-app-using-service-bus-queues.md
 

<!---HONumber=62-->